# 问题排查记录

## 节点获取问题 (已解决)

### 问题描述
- **现象**: kubectl命令能正常获取节点信息，但应用中节点数量显示为0或undefined
- **环境**: Kubernetes集群版本较老，使用Token认证方式
- **错误**: 应用无法获取到节点列表，但其他资源(如Deployment)可以正常获取

### 根本原因
**k8s.io API版本与集群版本不兼容**
- 应用使用的k8s.io依赖版本过高 (v0.33.4)
- 集群版本较老，不支持新版本API的某些特性
- 导致节点资源访问失败，但其他资源正常

### 解决方案
将k8s.io相关依赖降级到兼容版本：
```go
// go.mod 中的修改
k8s.io/api v0.29.0
k8s.io/apimachinery v0.29.0
k8s.io/client-go v0.29.0
```

### 修复步骤
1. 修改 `go.mod` 文件，将k8s.io依赖版本改为v0.29.0
2. 删除 `go.sum` 文件
3. 运行 `go mod tidy` 重新下载依赖
4. 重启应用服务

### 验证方法
- 使用独立测试程序验证API连接
- 检查前端页面节点数量显示是否正常
- 确认kubectl和应用获取的节点信息一致

### 经验总结
- k8s.io客户端库版本需要与目标集群版本兼容
- 新版本的客户端库可能不向后兼容老版本集群
- 建议使用与集群版本匹配或稍低的客户端库版本
- 在生产环境中，应该先在测试环境验证API兼容性

### 相关文件
- `go.mod` - 依赖版本管理
- `internal/handlers/cluster_db.go` - 集群节点信息获取
- `internal/services/k8s_client.go` - Kubernetes客户端封装

---

## MySQL表迁移失败问题 (已解决)

### 问题描述
- **现象**: 数据库表自动迁移时报错，无法正常创建表结构
- **环境**: MySQL 8.0+，使用GORM进行ORM操作
- **错误**: 表迁移过程中出现字段类型、外键约束、索引创建等相关错误

### 根本原因
**GORM MySQL驱动版本兼容性问题**
- 使用的 `gorm.io/driver/mysql v1.5.2` 版本存在已知bug
- 对MySQL 8.0+的某些特性支持不完善
- 字段类型映射和约束处理存在问题

### 解决方案
升级MySQL驱动到最新稳定版本：
```go
// go.mod 中的修改
gorm.io/driver/mysql v1.5.6  // 从 v1.5.2 升级
gorm.io/gorm v1.30.1         // 从 v1.30.0 升级
```

### 修复步骤
1. 修改 `go.mod` 文件中的MySQL驱动版本
2. 运行 `go mod tidy` 更新依赖
3. 运行 `go get gorm.io/gorm@latest` 更新GORM核心库
4. 重启应用测试表迁移

### 版本更新详情
- **MySQL驱动**: v1.5.2 → v1.5.6
  - 修复了表迁移相关的多个bug
  - 改进了对MySQL 8.0+的兼容性
  - 优化了字段类型映射和约束处理
- **GORM核心**: v1.30.0 → v1.30.1
  - 修复了AutoMigrate的稳定性问题
  - 改进了外键约束处理逻辑

### 验证方法
- 运行应用启动，观察数据库迁移日志
- 检查MySQL数据库中表结构是否正确创建
- 验证外键约束、索引、字段类型是否符合预期

### 经验总结
- GORM MySQL驱动版本对表迁移稳定性影响很大
- 新版本MySQL(8.0+)建议使用较新的驱动版本
- 表迁移问题通常与驱动兼容性相关，优先考虑版本升级
- 在生产环境中应该充分测试表迁移的稳定性

### 相关文件
- `go.mod` - 依赖版本管理
- `internal/database/database.go` - 数据库初始化和迁移逻辑
- `internal/models/` - 数据模型定义
