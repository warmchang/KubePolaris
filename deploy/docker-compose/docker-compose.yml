# ==========================================
# KubePolaris Docker Compose - æœ¬åœ°å¼€å‘ç¯å¢ƒ
# ==========================================
# ä½¿ç”¨æ–¹æ³•:
#   cd deploy/docker-compose
#   cp .env.example .env  # å…ˆå¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
#   docker-compose up -d
#   docker-compose logs -f
#   docker-compose down
# ==========================================


services:
  # ==========================================
  # MySQL æ•°æ®åº“
  # ==========================================
  mysql:
    image: mysql:8.0
    container_name: kubepolaris-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: kubepolaris
      MYSQL_USER: kubepolaris
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ../docker/mysql/init:/docker-entrypoint-initdb.d:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - kubepolaris-network
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$$MYSQL_ROOT_PASSWORD || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ==========================================
  # KubePolaris åç«¯
  # ==========================================
  backend:
    build:
      context: ../..
      dockerfile: deploy/docker/kubepolaris/Dockerfile.backend
    image: kubepolaris/backend:dev
    container_name: kubepolaris-backend
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      SERVER_PORT: 8080
      SERVER_MODE: debug
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USERNAME: kubepolaris
      DB_PASSWORD: ${MYSQL_PASSWORD}
      DB_DATABASE: kubepolaris
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRE_TIME: 24
      LOG_LEVEL: debug
      GRAFANA_ENABLED: "true"
      GRAFANA_URL: http://grafana:3000
      GRAFANA_API_KEY_FILE: /app/grafana/secrets/grafana_api_key
      TZ: Asia/Shanghai
    ports:
      - "8080:8080"
    volumes:
      - ../../configs:/app/configs:ro
      - ../docker/grafana/secrets:/app/grafana/secrets:ro
      - ~/.kube:/root/.kube:ro
    networks:
      - kubepolaris-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================
  # KubePolaris å‰ç«¯
  # ==========================================
  frontend:
    build:
      context: ../..
      dockerfile: deploy/docker/kubepolaris/Dockerfile.frontend
    image: kubepolaris/frontend:dev
    container_name: kubepolaris-frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    environment:
      TZ: Asia/Shanghai
    ports:
      - "80:80"
    networks:
      - kubepolaris-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Grafana
  # ==========================================
  grafana:
    image: grafana/grafana:10.2.0
    container_name: kubepolaris-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_SECURITY_ALLOW_EMBEDDING: "true"
      GF_SECURITY_COOKIE_SAMESITE: lax
      GF_SECURITY_COOKIE_SECURE: "false"
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
      GF_AUTH_ANONYMOUS_ORG_NAME: Main Org.
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_LOG_LEVEL: info
      GF_SERVER_ROOT_URL: http://localhost:3000
      TZ: Asia/Shanghai
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ../docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ../docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - kubepolaris-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Grafana åˆå§‹åŒ–ï¼ˆè‡ªåŠ¨ç”Ÿæˆ API Keyï¼‰
  # ==========================================
  grafana-init:
    image: curlimages/curl:latest
    container_name: kubepolaris-grafana-init
    depends_on:
      grafana:
        condition: service_healthy
    environment:
      GRAFANA_URL: http://grafana:3000
      GRAFANA_USER: admin
      GRAFANA_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - ../docker/grafana/secrets:/secrets
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "â³ ç­‰å¾… Dashboard åŠ è½½å®Œæˆ..."
        sleep 5
        
        echo "ğŸ”§ è®¾ç½® KubePolaris æ–‡ä»¶å¤¹æƒé™..."
        curl -s -X POST \
          -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
          -H "Content-Type: application/json" \
          -d '{"items":[{"role":"Viewer","permission":1},{"role":"Editor","permission":2}]}' \
          "$${GRAFANA_URL}/api/folders/kubepolaris-folder/permissions"
        echo " âœ… æƒé™è®¾ç½®å®Œæˆ"
        
        echo ""
        echo "ğŸ”‘ åˆ›å»º Service Account å’Œ API Token..."
        
        SA_EXISTS=$$(curl -s -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
          "$${GRAFANA_URL}/api/serviceaccounts/search?query=kubepolaris" | grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)
        
        if [ -z "$$SA_EXISTS" ]; then
          echo "  ğŸ“ åˆ›å»ºæ–°çš„ Service Account..."
          SA_RESULT=$$(curl -s -X POST \
            -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
            -H "Content-Type: application/json" \
            -d '{"name":"kubepolaris","role":"Admin","isDisabled":false}' \
            "$${GRAFANA_URL}/api/serviceaccounts")
          SA_ID=$$(echo "$$SA_RESULT" | grep -o '"id":[0-9]*' | cut -d: -f2)
          echo "  âœ… Service Account åˆ›å»ºæˆåŠŸï¼ŒID: $$SA_ID"
        else
          SA_ID=$$SA_EXISTS
          echo "  â„¹ï¸  Service Account å·²å­˜åœ¨ï¼ŒID: $$SA_ID"
        fi
        
        curl -s -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
          "$${GRAFANA_URL}/api/serviceaccounts/$$SA_ID/tokens" | \
          grep -o '"id":[0-9]*' | cut -d: -f2 | while read TOKEN_ID; do
            curl -s -X DELETE \
              -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
              "$${GRAFANA_URL}/api/serviceaccounts/$$SA_ID/tokens/$$TOKEN_ID"
          done
        
        echo "  ğŸ” ç”Ÿæˆæ–°çš„ API Token..."
        TOKEN_RESULT=$$(curl -s -X POST \
          -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
          -H "Content-Type: application/json" \
          -d '{"name":"kubepolaris-token","secondsToLive":0}' \
          "$${GRAFANA_URL}/api/serviceaccounts/$$SA_ID/tokens")
        
        API_KEY=$$(echo "$$TOKEN_RESULT" | grep -o '"key":"[^"]*"' | cut -d'"' -f4)
        
        if [ -n "$$API_KEY" ]; then
          echo "$$API_KEY" > /secrets/grafana_api_key
          echo "  âœ… API Token å·²ä¿å­˜åˆ° /secrets/grafana_api_key"
          echo ""
          echo "=========================================="
          echo "ğŸ‰ Grafana åˆå§‹åŒ–å®Œæˆï¼"
          echo "=========================================="
        else
          echo "  âŒ Token åˆ›å»ºå¤±è´¥: $$TOKEN_RESULT"
          exit 1
        fi
    networks:
      - kubepolaris-network
    restart: "no"

# ==========================================
# æ•°æ®å·
# ==========================================
volumes:
  mysql_data:
    name: kubepolaris-mysql-data
  grafana_data:
    name: kubepolaris-grafana-data

# ==========================================
# ç½‘ç»œ
# ==========================================
networks:
  kubepolaris-network:
    name: kubepolaris-network
    driver: bridge
