# ==========================================
# KubePolaris Docker Compose - 生产环境
# ==========================================
# 使用方法:
#   cd deploy/docker-compose
#   cp .env.example .env  # 先复制并配置环境变量
#   docker-compose -f docker-compose.prod.yml up -d
# ==========================================


services:
  # ==========================================
  # MySQL 数据库（生产环境建议使用外部数据库）
  # ==========================================
  mysql:
    image: mysql:8.0
    container_name: kubepolaris-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: kubepolaris
      MYSQL_USER: kubepolaris
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: Asia/Shanghai
    volumes:
      - mysql_data:/var/lib/mysql
      - ../docker/mysql/init:/docker-entrypoint-initdb.d:ro
      - ../docker/mysql/conf:/etc/mysql/conf.d:ro
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max_connections=500
      - --innodb_buffer_pool_size=1G
      - --slow_query_log=1
      - --slow_query_log_file=/var/lib/mysql/slow.log
      - --long_query_time=2
    networks:
      - kubepolaris-network
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$$MYSQL_ROOT_PASSWORD || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # ==========================================
  # KubePolaris 一体化服务
  # ==========================================
  kubepolaris:
    build:
      context: ../..
      dockerfile: deploy/docker/kubepolaris/Dockerfile
    image: kubepolaris/kubepolaris:${VERSION}
    container_name: kubepolaris
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      SERVER_PORT: 8080
      SERVER_MODE: release
      DB_DRIVER: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USERNAME: kubepolaris
      DB_PASSWORD: ${MYSQL_PASSWORD}
      DB_DATABASE: kubepolaris
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRE_TIME: 24
      LOG_LEVEL: info
      GRAFANA_ENABLED: "true"
      GRAFANA_URL: http://grafana:3000
      GRAFANA_API_KEY_FILE: /app/grafana/secrets/grafana_api_key
      TZ: Asia/Shanghai
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - ../docker/grafana/secrets:/app/grafana/secrets:ro
      - kubepolaris_logs:/app/logs
    networks:
      - kubepolaris-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ==========================================
  # Grafana
  # ==========================================
  grafana:
    image: grafana/grafana:10.2.0
    container_name: kubepolaris-grafana
    restart: always
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_SECURITY_ALLOW_EMBEDDING: "true"
      GF_SECURITY_COOKIE_SAMESITE: lax
      GF_SECURITY_COOKIE_SECURE: "true"
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
      GF_AUTH_ANONYMOUS_ORG_NAME: Main Org.
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_DATABASE_TYPE: sqlite3
      GF_LOG_LEVEL: warn
      GF_LOG_MODE: console
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL}
      GF_SERVER_ENABLE_GZIP: "true"
      TZ: Asia/Shanghai
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ../docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ../docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - kubepolaris-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # ==========================================
  # Grafana 初始化
  # ==========================================
  grafana-init:
    image: curlimages/curl:latest
    container_name: kubepolaris-grafana-init
    depends_on:
      grafana:
        condition: service_healthy
    environment:
      GRAFANA_URL: http://grafana:3000
      GRAFANA_USER: admin
      GRAFANA_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - ../docker/grafana/secrets:/secrets
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "⏳ Initializing Grafana..."
        sleep 5
        
        curl -s -X POST \
          -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
          -H "Content-Type: application/json" \
          -d '{"items":[{"role":"Viewer","permission":1},{"role":"Editor","permission":2}]}' \
          "$${GRAFANA_URL}/api/folders/kubepolaris-folder/permissions"
        
        SA_EXISTS=$$(curl -s -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
          "$${GRAFANA_URL}/api/serviceaccounts/search?query=kubepolaris" | grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)
        
        if [ -z "$$SA_EXISTS" ]; then
          SA_RESULT=$$(curl -s -X POST \
            -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
            -H "Content-Type: application/json" \
            -d '{"name":"kubepolaris","role":"Admin","isDisabled":false}' \
            "$${GRAFANA_URL}/api/serviceaccounts")
          SA_ID=$$(echo "$$SA_RESULT" | grep -o '"id":[0-9]*' | cut -d: -f2)
        else
          SA_ID=$$SA_EXISTS
        fi
        
        curl -s -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
          "$${GRAFANA_URL}/api/serviceaccounts/$$SA_ID/tokens" | \
          grep -o '"id":[0-9]*' | cut -d: -f2 | while read TOKEN_ID; do
            curl -s -X DELETE \
              -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
              "$${GRAFANA_URL}/api/serviceaccounts/$$SA_ID/tokens/$$TOKEN_ID"
          done
        
        TOKEN_RESULT=$$(curl -s -X POST \
          -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
          -H "Content-Type: application/json" \
          -d '{"name":"kubepolaris-token","secondsToLive":0}' \
          "$${GRAFANA_URL}/api/serviceaccounts/$$SA_ID/tokens")
        
        API_KEY=$$(echo "$$TOKEN_RESULT" | grep -o '"key":"[^"]*"' | cut -d'"' -f4)
        
        if [ -n "$$API_KEY" ]; then
          echo "$$API_KEY" > /secrets/grafana_api_key
          echo "✅ Grafana initialized successfully!"
        else
          echo "❌ Failed to create API token"
          exit 1
        fi
    networks:
      - kubepolaris-network
    restart: "no"

# ==========================================
# 数据卷
# ==========================================
volumes:
  mysql_data:
    name: kubepolaris-mysql-data-prod
  grafana_data:
    name: kubepolaris-grafana-data-prod
  kubepolaris_logs:
    name: kubepolaris-logs-prod

# ==========================================
# 网络
# ==========================================
networks:
  kubepolaris-network:
    name: kubepolaris-network-prod
    driver: bridge
