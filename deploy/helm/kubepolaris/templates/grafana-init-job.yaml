{{- if .Values.grafana.enabled }}
# Grafana Init RBAC - æˆæƒ Job åˆ›å»º Secret
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "kubepolaris.fullname" . }}-grafana-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kubepolaris.labels" . | nindent 4 }}
    app.kubernetes.io/component: grafana-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "kubepolaris.fullname" . }}-grafana-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kubepolaris.labels" . | nindent 4 }}
    app.kubernetes.io/component: grafana-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "update", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "kubepolaris.fullname" . }}-grafana-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kubepolaris.labels" . | nindent 4 }}
    app.kubernetes.io/component: grafana-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "kubepolaris.fullname" . }}-grafana-init
subjects:
- kind: ServiceAccount
  name: {{ include "kubepolaris.fullname" . }}-grafana-init
  namespace: {{ .Release.Namespace }}
---
# Grafana åˆå§‹åŒ– Job - è®¾ç½®æ–‡ä»¶å¤¹æƒé™ã€åˆ›å»º Service Account å¹¶è‡ªåŠ¨åˆ›å»º API Key Secret
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "kubepolaris.fullname" . }}-grafana-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kubepolaris.labels" . | nindent 4 }}
    app.kubernetes.io/component: grafana-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 5
  template:
    metadata:
      labels:
        {{- include "kubepolaris.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: grafana-init
    spec:
      {{- include "kubepolaris.imagePullSecrets" . | nindent 6 }}
      serviceAccountName: {{ include "kubepolaris.fullname" . }}-grafana-init
      restartPolicy: OnFailure
      containers:
      - name: grafana-init
        image: {{ include "kubepolaris.image" (dict "repository" .Values.grafana.init.image.repository "tag" .Values.grafana.init.image.tag "Values" .Values "Chart" .Chart) }}
        imagePullPolicy: {{ .Values.grafana.init.image.pullPolicy }}
        env:
        - name: GRAFANA_URL
          value: "http://{{ include "kubepolaris.fullname" . }}-grafana:{{ .Values.grafana.service.port }}"
        - name: GRAFANA_USER
          value: "admin"
        - name: GRAFANA_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "kubepolaris.grafana.secretName" . }}
              key: {{ .Values.grafana.existingSecretPasswordKey }}
        - name: NAMESPACE
          value: {{ .Release.Namespace | quote }}
        - name: SECRET_NAME
          value: "{{ include "kubepolaris.fullname" . }}-grafana-api-key"
        command:
        - /bin/sh
        - -c
        - |
          echo "â³ ç­‰å¾… Grafana å¯åŠ¨..."
          for i in $(seq 1 60); do
            if curl -s "${GRAFANA_URL}/api/health" | grep -q "ok"; then
              echo "âœ… Grafana å·²å°±ç»ª"
              break
            fi
            echo "ç­‰å¾…ä¸­... ($i/60)"
            sleep 5
          done

          echo ""
          echo "â³ ç­‰å¾… Dashboard åŠ è½½å®Œæˆ..."
          sleep 10

          echo ""
          echo "ğŸ”§ è®¾ç½® KubePolaris æ–‡ä»¶å¤¹æƒé™..."
          PERM_RESULT=$(curl -s -X POST \
            -u "${GRAFANA_USER}:${GRAFANA_PASSWORD}" \
            -H "Content-Type: application/json" \
            -d '{"items":[{"role":"Viewer","permission":1},{"role":"Editor","permission":2}]}' \
            "${GRAFANA_URL}/api/folders/kubepolaris-folder/permissions")
          echo "æƒé™è®¾ç½®ç»“æœ: ${PERM_RESULT}"
          echo "âœ… æƒé™è®¾ç½®å®Œæˆ"

          echo ""
          echo "ğŸ”‘ åˆ›å»º Service Account å’Œ API Token..."

          # æ£€æŸ¥ Service Account æ˜¯å¦å­˜åœ¨
          SA_EXISTS=$(curl -s -u "${GRAFANA_USER}:${GRAFANA_PASSWORD}" \
            "${GRAFANA_URL}/api/serviceaccounts/search?query=kubepolaris" | grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)

          if [ -z "${SA_EXISTS}" ]; then
            echo "  ğŸ“ åˆ›å»ºæ–°çš„ Service Account..."
            SA_RESULT=$(curl -s -X POST \
              -u "${GRAFANA_USER}:${GRAFANA_PASSWORD}" \
              -H "Content-Type: application/json" \
              -d '{"name":"kubepolaris","role":"Admin","isDisabled":false}' \
              "${GRAFANA_URL}/api/serviceaccounts")
            SA_ID=$(echo "${SA_RESULT}" | grep -o '"id":[0-9]*' | cut -d: -f2)
            echo "  âœ… Service Account åˆ›å»ºæˆåŠŸï¼ŒID: ${SA_ID}"
          else
            SA_ID=${SA_EXISTS}
            echo "  â„¹ï¸  Service Account å·²å­˜åœ¨ï¼ŒID: ${SA_ID}"
          fi

          # åˆ é™¤æ—§çš„ Token
          curl -s -u "${GRAFANA_USER}:${GRAFANA_PASSWORD}" \
            "${GRAFANA_URL}/api/serviceaccounts/${SA_ID}/tokens" | \
            grep -o '"id":[0-9]*' | cut -d: -f2 | while read TOKEN_ID; do
              curl -s -X DELETE \
                -u "${GRAFANA_USER}:${GRAFANA_PASSWORD}" \
                "${GRAFANA_URL}/api/serviceaccounts/${SA_ID}/tokens/${TOKEN_ID}"
            done

          echo "  ğŸ” ç”Ÿæˆæ–°çš„ API Token..."
          TOKEN_RESULT=$(curl -s -X POST \
            -u "${GRAFANA_USER}:${GRAFANA_PASSWORD}" \
            -H "Content-Type: application/json" \
            -d '{"name":"kubepolaris-token","secondsToLive":0}' \
            "${GRAFANA_URL}/api/serviceaccounts/${SA_ID}/tokens")

          API_KEY=$(echo "${TOKEN_RESULT}" | grep -o '"key":"[^"]*"' | cut -d'"' -f4)

          if [ -n "${API_KEY}" ]; then
            echo "  âœ… API Token åˆ›å»ºæˆåŠŸ"
            echo ""
            echo "ğŸ”§ è‡ªåŠ¨åˆ›å»º/æ›´æ–° Grafana API Key Secret..."
            
            # ä½¿ç”¨ kubectl åˆ›å»ºæˆ–æ›´æ–° Secret
            kubectl create secret generic "${SECRET_NAME}" \
              --from-literal=grafana-api-key="${API_KEY}" \
              -n "${NAMESPACE}" \
              --dry-run=client -o yaml | kubectl apply -f -
            
            if [ $? -eq 0 ]; then
              echo "âœ… Secret ${SECRET_NAME} åˆ›å»º/æ›´æ–°æˆåŠŸ"
              echo ""
              echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡ä»¥åŠ è½½æ–°çš„ API Key..."
              kubectl rollout restart deployment {{ include "kubepolaris.fullname" . }}-backend -n "${NAMESPACE}"
              if [ $? -eq 0 ]; then
                echo "âœ… åç«¯æœåŠ¡é‡å¯æˆåŠŸ"
              else
                echo "âš ï¸  åç«¯æœåŠ¡é‡å¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é‡å¯"
              fi
              echo ""
              echo "=========================================="
              echo "ğŸ‰ Grafana åˆå§‹åŒ–å®Œæˆï¼"
              echo "=========================================="
            else
              echo "âŒ Secret åˆ›å»ºå¤±è´¥"
              exit 1
            fi
          else
            echo "  âŒ Token åˆ›å»ºå¤±è´¥"
            echo "  ç»“æœ: ${TOKEN_RESULT}"
            exit 1
          fi

          echo ""
          echo "åˆå§‹åŒ–è„šæœ¬æ‰§è¡Œå®Œæˆ"
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
{{- end }}
